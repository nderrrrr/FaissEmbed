# Faiss Embed

æœ¬å°ˆæ¡ˆå±•ç¤ºå¦‚ä½•çµåˆ [**BGE-M3**](https://huggingface.co/BAAI/bge-m3) å‘é‡æ¨¡å‹èˆ‡ [**Faiss**](https://github.com/facebookresearch/faiss) å‘é‡æª¢ç´¢å¼•æ“ï¼Œå¯¦ä½œå°**åŸä½æ°‘æ—èªä¸­æ–‡å°è©±èªæ–™**çš„ dense retrieval åŠŸèƒ½ã€‚

---

## ğŸ” å°ˆæ¡ˆç‰¹è‰²

- ä½¿ç”¨ **BAAI/bge-m3** æ¨¡å‹ç”¢ç”Ÿ dense embeddingï¼Œå¯æ”¯æ´å¤šèªã€å¤šå±¤æ¬¡èªæ„ç†è§£ã€‚
- æ­é… **Faiss IndexFlatL2** åšæœ€è¿‘é„°æœå°‹ï¼ˆå‘é‡ç›¸ä¼¼åº¦ï¼‰ã€‚
- æ”¯æ´å¤šæ—èªå°è©±èªæ–™ï¼Œè‡ªå‹•è™•ç†å‘é‡åŒ–èˆ‡æª¢ç´¢ç´¢å¼•å»ºæ§‹ã€‚
- å‘é‡èˆ‡å°æ‡‰å°è©±ä½ç½®æœƒé å…ˆå„²å­˜ç‚º `.npy`ï¼Œå¤§å¹…æå‡æŸ¥è©¢æ•ˆç‡ã€‚

---

## ğŸ§  ä½¿ç”¨æ¨¡å‹

æœ¬å°ˆæ¡ˆæ¡ç”¨ [**BGE-M3** æ¨¡å‹](https://huggingface.co/BAAI/bge-m3)ï¼Œç‰¹é»åŒ…æ‹¬ï¼š

- è¼¸å‡º dense vectorsï¼Œé©åˆèªæ„æª¢ç´¢èˆ‡èªå¥ç›¸ä¼¼åº¦æ¯”è¼ƒã€‚
- æ”¯æ´é•·æ–‡æœ¬ï¼ˆæœ€å¤š 8192 tokensï¼‰ã€‚
- å¤šèªè¨€è¨“ç·´ï¼Œé©åˆæ‡‰ç”¨æ–¼ä¸­æ–‡èªæ–™ã€‚
- ä½¿ç”¨ [FlagEmbedding](https://github.com/FlagOpen/FlagEmbedding) å¥—ä»¶å°è£ï¼Œç°¡å–®é«˜æ•ˆã€‚

---

## ğŸ“ è³‡æ–™ç°¡ä»‹

æˆ‘å€‘è™•ç†äº†ä»¥ä¸‹äº”ç¨®åŸä½æ°‘æ—èªå°è©±èªæ–™ï¼ˆæ—èªèˆ‡ä¸­æ–‡å¹³è¡Œå¥ï¼‰ï¼Œè³‡æ–™çš†ä½æ–¼ `./data/` ç›®éŒ„ä¸‹ï¼š

| Tribe Code | ä¸­æ–‡åç¨±     | åŸä½æ°‘æ—èªåç¨±      |
|------------|--------------|---------------------|
| NSA        | å—å‹¢é˜¿ç¾     | Southern Amis       |
| CAA        | æµ·å²¸é˜¿ç¾     | Coastal Amis        |
| WDT        | è¬å¤§æ³°é›…     | Wanda Tayal         |
| SJT        | å››å­£æ³°é›…     | Siji Tayal          |
| DDS        | éƒ½é”è³½å¾·å…‹   | Duda Seediq         |

> ğŸ“‚ `data/` è³‡æ–™å¤¾å·²åŠ å…¥ `.gitignore`ï¼Œè«‹æ‰‹å‹•æ”¾ç½®ä½ æ“æœ‰çš„å°è©±èªæ–™ã€‚

---

## ğŸ“¦ å®‰è£æ–¹å¼

å»ºè­°åœ¨è™›æ“¬ç’°å¢ƒä¸­å®‰è£ï¼š

```bash
pip install -r requirements.txt
```

## ğŸ—ï¸ è³‡æ–™é è™•ç†æµç¨‹
è«‹å°‡æ¯ä¸€æ—èªçš„å°è©±è³‡æ–™ï¼ˆJSON æ ¼å¼ï¼‰æ”¾ç½®æ–¼ï¼š
```bash
./data/{tribe_code}/{tribe_code}_dialogue.json
```
æ¯æ®µå°è©±ç‚ºä¸€çµ„å¥å­å°æ‡‰çµæ§‹ï¼š
```json
[
    [
        ["æ—èª1", "ä½ å¥½"],
        ["æ—èª2", "ä½ ä»Šå¤©å¥½å—ï¼Ÿ"]
    ],
    [
        ["æ—èª3", "åƒé£¯äº†å—ï¼Ÿ"],
        ["æ—èª4", "é‚„æ²’ï¼Œä½ å‘¢ï¼Ÿ"]
    ]
]
```

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ç”¢ç”Ÿè©²æ—èªçš„ embedding èˆ‡å°æ‡‰ç´¢å¼•æª”æ¡ˆï¼š
```bash
python faiss_embed/prepare_data.py --tribe_code CAA
```
å®Œæˆå¾Œæœƒåœ¨ `./data/CAA/` ä¸­ç”¢ç”Ÿï¼š
- `CAA_embedding_list.npy`ï¼šæ‰€æœ‰ä¸­æ–‡å¥å­çš„å‘é‡è¡¨ç¤º
- `CAA_sentence_index_map.npy`ï¼šæ¯å€‹å¥å­å°æ‡‰åœ¨åŸå§‹å°è©±ä¸­çš„ä½ç½® (dialogue_id, utterance_id)

## ğŸ” æŸ¥è©¢èˆ‡æª¢ç´¢ç¯„ä¾‹
`usage_example.ipynb` æä¾›ä¸€å€‹ç¯„ä¾‹æŸ¥è©¢æµç¨‹ï¼š
1. è¼‰å…¥ `.npy` å‘é‡èˆ‡ä½ç½®ç´¢å¼•
2. å°‡æŸ¥è©¢å¥å­è½‰ç‚ºå‘é‡
3. åœ¨ Faiss ç´¢å¼•ä¸­æ‰¾æœ€ç›¸ä¼¼å¥å­
4. å›å‚³å…¶åœ¨åŸå§‹å°è©±ä¸­çš„ã€Œä¸‹ä¸€å¥ã€ä½œç‚ºå›æ‡‰å»ºè­°

è¼¸å‡ºç¯„ä¾‹ï¼š
```
æŸ¥è©¢å¥å­: ä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ
å›å‚³ä¸‹ä¸€å¥: å¤ªé™½å‡ºä¾†äº†ï¼Œå¤©æ°£å¾ˆç†±ã€‚
```

## ğŸ§  æŠ€è¡“ç´°ç¯€
ä½¿ç”¨ BGE-M3 æ¨¡å‹ç”¢ç”Ÿå¥å­å‘é‡ï¼š
```python
from FlagEmbedding import BGEM3FlagModel
model = BGEM3FlagModel("BAAI/bge-m3")
vecs = model.encode(["æˆ‘ä»Šå¤©å¾ˆå¥½"])["dense_vecs"]
```

ä½¿ç”¨ Faiss å»ºç«‹èˆ‡æŸ¥è©¢å‘é‡ç´¢å¼•ï¼š
```python
import faiss
index = faiss.IndexFlatL2(dim)
index.add(embedding_list)
D, I = index.search(query_vec, k=1)
```

## ğŸ“‚ å°ˆæ¡ˆçµæ§‹
```bash
FaissEmbed/
â”œâ”€â”€ faiss_embed/               # æ ¸å¿ƒæ¨¡çµ„
â”‚   â”œâ”€â”€ embedding_model.py     # BGE-M3 å‘é‡æ¨¡å‹å°è£
â”‚   â”œâ”€â”€ faiss_indexer.py       # å»ºç«‹èˆ‡æŸ¥è©¢ Faiss ç´¢å¼•
â”‚   â”œâ”€â”€ prepare_data.py        # è½‰æ›è³‡æ–™ä¸¦å„²å­˜ .npy å‘é‡èˆ‡ç´¢å¼•
â”œâ”€â”€ data/                      # èªæ–™è³‡æ–™ï¼ˆéœ€æ‰‹å‹•æ”¾å…¥ï¼Œå·²å¿½ç•¥ Gitï¼‰
â”‚   â””â”€â”€ CAA/...
â”œâ”€â”€ usage_example.py           # æŸ¥è©¢ç¯„ä¾‹ï¼šè¼¸å…¥å¥å­ â†’ å›å‚³ä¸‹ä¸€å¥
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```